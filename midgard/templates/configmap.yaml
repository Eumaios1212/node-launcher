apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "midgard.fullname" . }}-config
data:
  entrypoint.sh: |
    #!/bin/sh

    # get ordinal index of stateful set from hostname
    INDEX=${HOSTNAME##*-}
    sed -e "s/HOST_TIMESCALEDB/{{ include "midgard.fullname" . }}-timescaledb-${INDEX}.{{ include "midgard.fullname" . }}-timescaledb/g" /config.json.tpl > /config.json
    /midgard /config.json

  config.json: |
    {
      "listen_port": {{ .Values.service.port }},
      "thorchain": {
        "tendermint_url": "http://{{ include "midgard.thorDaemon" . }}/websocket",
        "thornode_url": "http://{{ .Values.thorApi }}/thorchain",
        "last_chain_backoff": "7s",
        "proxied_whitelisted_endpoints": [
          "inbound_addresses",
          "constants",
          "lastblock",
          "mimir",
          "queue"
        ]
      },
      "timescale": {
        "host": "HOST_TIMESCALEDB",
        "port": {{ .Values.postgres.port }},
        "user_name": "{{ .Values.postgres.username }}",
        "password": "{{ .Values.postgres.password }}",
        "database": "{{ .Values.postgres.database }}",
        "sslmode": "disable"
      }
    }
